function buscar(){msg=[];const obj={},dthj=new Date(Date.now()),urls=["fetch.php?f=fornecedor","fetch.php?f=operacoes","fetch.php?f=baixadas","fetch.php?f=taxas",`fetch.php?f=feriados&data=${dthj.getFullYear()}-${dthj.getMonth()+1}-${dthj.getDate()}`],moneyFormat=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2});let valorOriginal=0,valorJuros=0,valorTaxas=0,antecipadas=0;function montaHtml(){document.querySelector("#operacao-data").innerHTML=new Date(Date.now()).toLocaleDateString("pt-BR"),document.querySelector("#fornecedor").innerHTML=obj.fornecedor.razao;const tableOperacoes=document.querySelector("#table-operacoes");tableOperacoes.innerHTML="";let limite=obj.fornecedor.limite,disponivel=0,limiteTomado=0;obj.fornecedor.operacoes.length>0?obj.fornecedor.operacoes.forEach((op,i)=>{disponivel+=parseFloat(op.valor);const nf=op.nota.split("/"),dt=new Date(op.vencimento),juros=0===parseFloat(obj.fornecedor.juros)?2.5:parseFloat(obj.fornecedor.juros),diasMes=new Date(dthj.getFullYear(),dthj.getMonth()+1,0).getDate(),diaSem=dt.getDay();let diasAd=1;switch(diaSem){case 0:diasAd+=1;break;case 5:diasAd+=2;break;case 6:diasAd+=3}const dias=Math.floor((dt-dthj)/864e5)+diasAd;op.dias=dias,op.jurosDia=parseFloat(juros/diasMes).toFixed(2),op.valorDesconto=parseFloat(parseFloat(op.valor)*(op.jurosDia/100)*dias).toFixed(2);const tr=document.createElement("tr");tr.innerHTML=`\n\t\t\t\t\t<td>\n\t\t\t\t\t\t<div class="form-check form-check-custom form-check-solid">\n\t\t\t\t\t\t\t<input class="form-check-input operacoes-check" type="checkbox" data-attr="${i}" />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t<span class="text-muted fw-bold d-block fs-7">nota fiscal</span>\n\t\t\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${nf[0]}</span>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t<span class="text-muted fw-bold d-block fs-7">parcela</span>\n\t\t\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${nf[1]}</span>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t<span class="text-muted fw-bold d-block fs-7">a receber</span>\n\t\t\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${moneyFormat.format(op.valor)}</span>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t<span class="text-muted fw-bold d-block fs-7">vencimento</span>\n\t\t\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${dt.toLocaleDateString("pt-BR")}</span>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t<span class="text-muted fw-bold d-block fs-7">juros/mês</span>\n\t\t\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${juros}%</span>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t<span class="text-muted fw-bold d-block fs-7">dias</span>\n\t\t\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${op.dias}</span>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t<span class="text-muted fw-bold d-block fs-7">descontos</span>\n\t\t\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${moneyFormat.format(parseFloat(op.valorDesconto).toFixed(2))}*</span>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td style="width:50px;">\n\t\t\t\t\t\t<span class="d-block fs-7">&nbsp;</span>\n\t\t\t\t\t</td>\n\t\t\t\t`,tableOperacoes.appendChild(tr)}):(tableOperacoes.innerHTML="",atualizaAntecipacao()),obj.fornecedor.baixadas.length>0&&obj.fornecedor.baixadas.forEach((bx,i)=>{limiteTomado+=parseFloat(bx.valor)}),document.querySelector("#limiteDisponivel").innerHTML=moneyFormat.format(limite-limiteTomado),document.querySelector("#disponivel").innerHTML=moneyFormat.format(disponivel),document.querySelector("#limiteTomado").innerHTML=moneyFormat.format(limiteTomado),observaCheckboxes()}function observaCheckboxes(){const checkboxes=document.querySelectorAll(".operacoes-check");checkboxes.forEach(c=>{c.addEventListener("click",()=>{const index=c.getAttribute("data-attr");obj.fornecedor.operacoes[index].antecipar=!!c.checked,atualizaAntecipacao()})})}function atualizaAntecipacao(){valorOriginal=0,valorJuros=0,valorTaxas=0,antecipadas=0,txBoleto=0,txTed=0,txTac=0,obj.fornecedor.operacoes.forEach(op=>{!0===op.antecipar&&(valorOriginal+=parseFloat(op.valor),valorJuros+=parseFloat(op.valorDesconto),antecipadas++)}),txBoleto=0===parseFloat(obj.fornecedor.boleto)?parseFloat(obj.taxas.find(v=>"BOLETO"===v.titulo).valor):parseFloat(obj.fornecedor.boleto),txTed=0===parseFloat(obj.fornecedor.ted)?parseFloat(obj.taxas.find(v=>"TED"===v.titulo).valor):parseFloat(obj.fornecedor.ted),txTac=0===parseFloat(obj.fornecedor.tac)?parseFloat(obj.taxas.find(v=>"TAC"===v.titulo).valor):parseFloat(obj.fornecedor.tac),valorTaxas+=txBoleto*antecipadas+txTed+txTac;const footerOperacoes=document.querySelector("#footer-operacoes"),tr=document.createElement("tr");let btn="";btn=0===dthj.getDay()||6===dthj.getDay()||"false"!==obj.feriado?'<span class="d-block fs-7">&nbsp;</span>':'\n\t\t\t<button class="btn btn-active-icon-primary btn-active-text-primary" style="margin:0; padding:0;" id="efetuar-antecipadas">\n\t\t\t\t\x3c!--begin::Svg Icon | path: assets/media/icons/duotune/arrows/arr016.svg--\x3e\n\t\t\t\t<span class="svg-icon svg-icon-muted svg-icon-2hx"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">\n\t\t\t\t<path opacity="0.3" d="M10.3 14.3L11 13.6L7.70002 10.3C7.30002 9.9 6.7 9.9 6.3 10.3C5.9 10.7 5.9 11.3 6.3 11.7L10.3 15.7C9.9 15.3 9.9 14.7 10.3 14.3Z" fill="black"/>\n\t\t\t\t<path d="M22 12C22 17.5 17.5 22 12 22C6.5 22 2 17.5 2 12C2 6.5 6.5 2 12 2C17.5 2 22 6.5 22 12ZM11.7 15.7L17.7 9.70001C18.1 9.30001 18.1 8.69999 17.7 8.29999C17.3 7.89999 16.7 7.89999 16.3 8.29999L11 13.6L7.70001 10.3C7.30001 9.89999 6.69999 9.89999 6.29999 10.3C5.89999 10.7 5.89999 11.3 6.29999 11.7L10.3 15.7C10.5 15.9 10.8 16 11 16C11.2 16 11.5 15.9 11.7 15.7Z" fill="black"/>\n\t\t\t\t</svg></span>\n\t\t\t\t\x3c!--end::Svg Icon--\x3e\n\t\t\t</button>\n\t\t\t',footerOperacoes.innerHTML="",tr.innerHTML=antecipadas>0?`\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block"></span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7"></span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5"></span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7"></span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5"></span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">valor original</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${moneyFormat.format(valorOriginal.toFixed(2))}</span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">vencimento</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${dthj.toLocaleDateString("pt-BR")}</span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">desconto juros</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${moneyFormat.format(valorJuros.toFixed(2))}</span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">desconto taxas</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${moneyFormat.format(valorTaxas.toFixed(2))}</span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">valor antecipação</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">${moneyFormat.format(parseFloat(valorOriginal-(valorJuros+valorTaxas)).toFixed(2))}*</span>\n\t\t\t</td>\n\t\t\t<td style="width:50px; text-align:center;">\n\t\t\t\t${btn}\n\t\t\t</td>\n\t\t`:'\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block"></span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7"></span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5"></span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7"></span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5"></span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">valor original</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">R$ 0,00</span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">vencimento</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">--/--/----</span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">desconto juros</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">R$ 0,00</span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">desconto taxas</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">R$ 0,00</span>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t\t<span class="text-muted fw-bold d-block fs-7">valor antecipação</span>\n\t\t\t\t<span class="text-dark fw-bolder d-block fs-5">R$ 0,00*</span>\n\t\t\t</td>\n\t\t\t<td style="width:50px;">\n\t\t\t\t<span class="d-block fs-7">&nbsp;</span>\n\t\t\t</td>\n\t\t',footerOperacoes.appendChild(tr);let id=null;antecipadas>0&&document.querySelector("#efetuar-antecipadas").addEventListener("click",()=>{const prcts=[parseFloat((30/antecipadas).toFixed(2)),25,45],efetuando=document.querySelector("#antecipadas-efetuando"),porcentagem=document.querySelector("#antecipadas-porcentagem"),progressbar=document.querySelector("#antecipadas-progressbar"),mensagem=document.querySelector("#antecipadas-modal-msg"),titulo=document.querySelector("#antecipadas-titulo");let pcent=0;exibeModal();const data={metodo:"antecipadas",fornecedor:obj.fornecedor.id,data:dthj.toISOString().split("T")[0],valorOriginal:valorOriginal,descontoJuros:valorJuros,descontoTaxas:valorTaxas,valor:valorOriginal-(valorJuros+valorTaxas),status:0};fetch("fetch.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(data)}).then(res=>res.text()).then(res=>{id=parseInt(res,10);const paraAntecipar=obj.fornecedor.operacoes.filter(op=>!0===op.antecipar),dataFetches=[];paraAntecipar.forEach(a=>{const dataOp={metodo:"detalhes",antecipada:id,operacao:a.id,nota:a.nota,data:dthj.toISOString().split("T")[0],valorOriginal:parseFloat(a.valor),descontoJuros:a.valorDesconto,valor:a.valor-a.valorDesconto};dataFetches.push(dataOp)}),Promise.all(dataFetches.map(d=>{efetuando.innerHTML="Efetuando antecipação nota fiscal "+d.nota+"…",porcentagem.innerHTML=pcent+"%",fetch("fetch.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(d)}).then(res=>res.text()).then(res=>{pcent+=prcts[0],porcentagem.innerHTML=pcent+"%",progressbar.setAttribute("aria-valuenow",pcent),progressbar.style.width=pcent+"%",mensagem.innerHTML+="✔ Operação com nota fiscal "+d.nota+" antecipada.<br>"})})).then(()=>{setTimeout((function(){efetuando.innerHTML="Redigindo contrato para a operação "+id+"…",fetch("contrato.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({id:id})}).then(res=>res.text()).then(json=>{!0===(json=JSON.parse(json)).criado?(pcent+=prcts[1],porcentagem.innerHTML=pcent+"%",progressbar.setAttribute("aria-valuenow",pcent),progressbar.style.width=pcent+"%",mensagem.innerHTML+='✔ Contrato criado: <a target="_blank" href="'+json.nome+'">'+json.nome+"</a>.<br>",efetuando.innerHTML="Enviando contrato para assinaturas…",fetch("autentique.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({emailEmpresa:json.emailEmpresa,arquivo:json.nome})}).then(res=>res.text()).then(res=>{if(res=JSON.parse(res),console.log(res),Array.isArray(res))if(4==res.length){let ret=JSON.parse(res[3]);pcent+=prcts[2],efetuando.innerHTML="",porcentagem.innerHTML=pcent+"%",progressbar.setAttribute("aria-valuenow",pcent),progressbar.style.width=pcent+"%",mensagem.innerHTML+="✔ Contrato enviado para assinaturas. Id autentique: "+ret.data.createDocument.id,titulo.innerHTML="Antecipação Concluída!"}else efetuando.innerHTML="",porcentagem.innerHTML="100%",progressbar.setAttribute("aria-valuenow",100),progressbar.style.width="100%",mensagem.innerHTML+="✖ Erro ao enviar contrato para assinatura.Erro: "+res,titulo.innerHTML="Antecipação Concluída!";else efetuando.innerHTML="",porcentagem.innerHTML="100%",progressbar.setAttribute("aria-valuenow",100),progressbar.style.width="100%",mensagem.innerHTML+="✖ Erro ao enviar contrato para assinatura. Erro: "+res,titulo.innerHTML="Antecipação Concluída!"})):(efetuando.innerHTML="",porcentagem.innerHTML="100%",progressbar.setAttribute("aria-valuenow",100),progressbar.style.width="100%",mensagem.innerHTML+="✖ Erro ao gerar contrato para operação "+id+".",titulo.innerHTML="Antecipação Concluída!")})}),250)})})})}Promise.all(urls.map(u=>fetch(u))).then(responses=>Promise.all(responses.map(res=>res.json()))).then(jsons=>{obj.fornecedor=jsons[0],obj.fornecedor.operacoes=jsons[1],obj.fornecedor.baixadas=jsons[2],obj.taxas=jsons[3],obj.feriado=jsons[4]}).finally(()=>montaHtml()).catch(()=>console.log("erro"))}function exibeModal(){const modal=document.querySelector("#trigger-modal"),fecha=document.querySelectorAll(".fecha-modal");fecha.forEach(f=>f.addEventListener("click",()=>buscar())),modal.click()}buscar();