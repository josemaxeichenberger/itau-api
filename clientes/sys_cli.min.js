function buscar(){msg=[];let e={},t=new Date(Date.now()),a=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2}),o=["fetch.php?f=fornecedor","fetch.php?f=operacoes","fetch.php?f=baixadas","fetch.php?f=taxas",`fetch.php?f=feriados&data=${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`],n=0,r=0,s=0,d=0,l=!0;function i(){let e=document.querySelectorAll(".efetuar-postergacao");e.forEach(e=>e.addEventListener("click",()=>c(e.getAttribute("data-attr"))))}function c(t){let o=e.fornecedor.operacoes[t];setTimeout(()=>{document.querySelector("#post-valor-original").innerHTML=a.format(o.valor),document.querySelector("#post-vencimento-original").innerHTML=new Date(o.vencimento).toLocaleDateString("pt-BR"),$("#post-vencimento-datepicker").daterangepicker({locale:{format:"DD/MM/YYYY",separator:" - ",applyLabel:"Selecionar",cancelLabel:"Cancelar",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",weekLabel:"S",daysOfWeek:["Dom","Seg","Ter","Qua","Qui","Sex","Sab"],monthNames:["Janeiro","Fevereiro","Mar\xe7o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"]},singleDatePicker:!0,autoApply:!0,minDate:moment(o.vencimento).subtract(1,"d").add(15,"d"),maxDate:moment(o.vencimento).subtract(1,"d").add(30,"d")}),$("#post-vencimento-datepicker").on("apply.daterangepicker",function(e,a){p(o,t)}),p(o,t);let n=document.querySelector("#trigger-modal-postergacao"),r=document.querySelectorAll(".fecha-modal-postergacao");r.forEach(e=>e.addEventListener("click",()=>buscar()));let s=document.querySelector("#proxima-modal-postergacao");s.addEventListener("click",()=>{r[0].click(),setTimeout(()=>{c(e.fornecedor.postergadas[l+1])},250)});let d=document.querySelector("#confirma-modal-postergacao"),l=e.fornecedor.postergadas.indexOf(t);l<e.fornecedor.postergadas.length-1?(d.style.display="none",s.style.display="block"):(s.style.display="none",d.addEventListener("click",()=>{r[0].click(),f()}),d.style.display="block"),n.click()},250)}function p(t,a){var o;let n,d=moment(t.vencimento),l=moment((n=(o=document.querySelector("#post-vencimento-datepicker").value).split("/"))[2]+"-"+n[1]+"-"+n[0]),i=0===parseFloat(e.fornecedor.juros)?2.5:parseFloat(e.fornecedor.juros);jurosDia=parseFloat(i/30).toFixed(2),r=parseFloat(parseFloat(t.valor)*(jurosDia/100)*(Math.floor((l-d)/864e5)+1)).toFixed(2),txBoleto=0===parseFloat(e.fornecedor.boleto)?parseFloat(e.taxas.find(e=>"BOLETO"===e.titulo).valor):parseFloat(e.fornecedor.boleto),txTac=0===parseFloat(e.fornecedor.tac)?parseFloat(e.taxas.find(e=>"TAC"===e.titulo).valor):parseFloat(e.fornecedor.tac),s=parseFloat(txBoleto)+parseFloat(txTac),valorNovo=(parseFloat(t.valor)+parseFloat(r)+parseFloat(s)).toFixed(2);let c={vencimento:new Date(l),valor:valorNovo,valorOriginal:t.valor,dataOPE:new Date,taxa:s,juros:r,status:0};e.fornecedor.novasOperacoes[a]=c}async function f(){let t=[parseFloat(30/e.fornecedor.postergadas.length).toFixed(2),25,45],a=document.querySelector("#antecipadas-efetuando"),o=document.querySelector("#antecipadas-porcentagem"),n=document.querySelector("#antecipadas-progressbar"),r=document.querySelector("#antecipadas-modal-msg"),s=document.querySelector("#antecipadas-titulo");s.innerHTML="Efetuando Posterga\xe7\xe3o…";let d=0;exibeModal();let l=await fetch("fetch.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({metodo:"nova_postergacao"})});console.log("POSTERGACAO id RESULT",l);let i=[],c=[];e.fornecedor.postergadas.forEach((t,n)=>{let r=e.fornecedor.operacoes[t],s=e.fornecedor.novasOperacoes[n];a.innerHTML="Efetuando posterga\xe7\xe3o nota fiscal "+r.nota+"…",o.innerHTML=d+"%";let c={metodo:"postergada",id:r.id,fornecedor:r.cnpj,nota:r.nota,valorOriginal:s.valorOriginal,vencimento:s.vencimento.toISOString().split("T")[0],valor:parseFloat(s.valor),status:s.status,taxas:s.taxa,juros:s.juros,postergacao_id:l};i.push(c)}),Promise.all(i.map(async(e,s)=>{a.innerHTML="Efetuando posterga\xe7\xe3o nota fiscal "+e.nota+"…",o.innerHTML=parseFloat(d)+"%",await fetch("fetch.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.text()).then(a=>{c.push(parseInt(a,10)),d+=parseFloat(t[0]),o.innerHTML=d+"%",n.setAttribute("aria-valuenow",d),n.style.width=parseInt(d,10)+"%",r.innerHTML+="✔ Opera\xe7\xe3o com nota fiscal "+e.nota+" postergada.<br>"})})).then(()=>{setTimeout(function(){a.innerHTML="Redigindo contrato para a opera\xe7\xf5es…",fetch("contrato.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({id:c.join(",")})}).then(e=>e.text()).then(e=>{console.log(e),!0===(e=JSON.parse(e)).criado?(d+=parseFloat(t[1]),o.innerHTML=d+"%",n.setAttribute("aria-valuenow",d),n.style.width=d+"%",r.innerHTML+='✔ Contrato criado: <a target="_blank" href="../'+e.nome+'">'+e.nome+"</a>.<br>",a.innerHTML="Enviando contrato para assinaturas…",fetch("autentique.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({emailEmpresa:e.emailEmpresa,arquivo:e.nome,id_operacao:e.id_operacao})}).then(e=>e.text()).then(e=>{if(e=JSON.parse(e),console.log(e),Array.isArray(e)){if(4==e.length){let l=JSON.parse(e[3]);d+=t[2],a.innerHTML="",o.innerHTML=d+"%",n.setAttribute("aria-valuenow",d),n.style.width=d+"%",r.innerHTML+="✔ Contrato enviado para assinaturas. Id autentique: "+l.data.createDocument.id,s.innerHTML="Posterga\xe7\xe3o Conclu\xedda!"}else a.innerHTML="",o.innerHTML="100%",n.setAttribute("aria-valuenow",100),n.style.width="100%",r.innerHTML+="✖ Erro ao enviar contrato para assinatura.Erro: "+e,s.innerHTML="Posterga\xe7\xe3o Conclu\xedda!"}else a.innerHTML="",o.innerHTML="100%",n.setAttribute("aria-valuenow",100),n.style.width="100%",r.innerHTML+="✖ Erro ao enviar contrato para assinatura. Erro: "+e,s.innerHTML="Posterga\xe7\xe3o Conclu\xedda!"})):(a.innerHTML="",o.innerHTML="100%",n.setAttribute("aria-valuenow",100),n.style.width="100%",r.innerHTML+="✖ Erro ao gerar contrato para opera\xe7\xe3o "+id+".",s.innerHTML="Posterga\xe7\xe3o Conclu\xedda!")})},250)})}function u(){n=0,r=0,s=0,d=0,txBoleto=0,txTed=0,txTac=0,l=!0,e.fornecedor.operacoes.forEach(e=>{!0===e.antecipar&&(n+=parseFloat(e.valor),r+=parseFloat(e.valorDesconto),"cliente"==e.tipo&&(l=!1),d++)}),txBoleto=0===parseFloat(e.fornecedor.boleto)?parseFloat(e.taxas.find(e=>"BOLETO"===e.titulo).valor):parseFloat(e.fornecedor.boleto),s+=txBoleto*d+(txTed=0===parseFloat(e.fornecedor.ted)?parseFloat(e.taxas.find(e=>"TED"===e.titulo).valor):parseFloat(e.fornecedor.ted))+(txTac=0===parseFloat(e.fornecedor.tac)?parseFloat(e.taxas.find(e=>"TAC"===e.titulo).valor):parseFloat(e.fornecedor.tac));let o=document.querySelector("#footer-operacoes"),i=document.createElement("tr"),p="";if(p=`
			<button data-bs-toggle="tooltip" data-bs-custom-class="tooltip-inverse" data-bs-placement="right" title="Postergar" class="btn btn-active-icon-primary btn-active-text-primary" style="margin:0; padding:0;float:right;" id="efetuar-postergadas">
				<!--begin::Svg Icon | path: /var/www/preview.keenthemes.com/kt-products/docs/metronic/html/releases/2022-09-15-053640/core/html/src/media/icons/duotune/arrows/arr030.svg-->
				<span class="svg-icon svg-icon-muted svg-icon-2hx"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M18.4 18H16C15.7 18 15.5 17.9 15.3 17.7L12.5 14.9C12.1 14.5 12.1 13.9 12.5 13.5C12.9 13.1 13.5 13.1 13.9 13.5L16.4 16H18.4V18ZM16 6C15.7 6 15.5 6.09999 15.3 6.29999L11 10.6L6.70001 6.29999C6.50001 6.09999 6.3 6 6 6H3C2.4 6 2 6.4 2 7C2 7.6 2.4 8 3 8H5.60001L9.60001 12L5.60001 16H3C2.4 16 2 16.4 2 17C2 17.6 2.4 18 3 18H6C6.3 18 6.50001 17.9 6.70001 17.7L16.4 8H18.4V6H16Z" fill="currentColor"/>
				<path opacity="0.3" d="M21.7 6.29999C22.1 6.69999 22.1 7.30001 21.7 7.70001L18.4 11V3L21.7 6.29999ZM18.4 13V21L21.7 17.7C22.1 17.3 22.1 16.7 21.7 16.3L18.4 13Z" fill="currentColor"/>
				</svg>
				</span>
				<!--end::Svg Icon-->
			</button>
			`,o.innerHTML="",d>0){let f=l?""+p:p;i.innerHTML=`
			<td>
				<span class="text-muted fw-bold d-block"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">valor original</span>
				<span class="text-dark fw-bolder d-block fs-5">${a.format(n.toFixed(2))}</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">vencimento</span>
				<span class="text-dark fw-bolder d-block fs-5">${t.toLocaleDateString("pt-BR")}</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">desconto juros</span>
				<span class="text-dark fw-bolder d-block fs-5">${a.format(r.toFixed(2))}</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">desconto taxas</span>
				<span class="text-dark fw-bolder d-block fs-5">${a.format(s.toFixed(2))}</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">valor antecipa\xe7\xe3o</span>
				<span class="text-dark fw-bolder d-block fs-5">${a.format(parseFloat(n-(r+s)).toFixed(2))}*</span>
			</td>
			<td style="width:100px; text-align:center;">
				${f}
			</td>
		`}else i.innerHTML=`
			<td>
				<span class="text-muted fw-bold d-block"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td style="width:100px;">
				<span class="d-block fs-7">&nbsp;</span>
			</td>
		`;o.appendChild(i),execTooltips();let u=null;d>0&&(document.querySelector("#efetuar-postergadas").addEventListener("click",()=>{e.fornecedor.postergadas.length>0&&c(e.fornecedor.postergadas[0])}),document.querySelector("#efetuar-antecipadas").addEventListener("click",()=>{let a=[parseFloat((30/d).toFixed(2)),25,45],o=document.querySelector("#antecipadas-efetuando"),l=document.querySelector("#antecipadas-porcentagem"),i=document.querySelector("#antecipadas-progressbar"),c=document.querySelector("#antecipadas-modal-msg"),p=document.querySelector("#antecipadas-titulo");p.innerHTML="Efetuando Antecipa\xe7\xf5es…";let f=0;exibeModal();let b={metodo:"antecipadas",fornecedor:e.fornecedor.id,data:t.toISOString().split("T")[0],valorOriginal:n,descontoJuros:r,descontoTaxas:s,valor:n-(r+s),status:0};fetch("fetch.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(b)}).then(e=>e.text()).then(n=>{u=parseInt(n,10);let r=e.fornecedor.operacoes.filter(e=>!0===e.antecipar),s=[];r.forEach(e=>{let a={metodo:"detalhes",antecipada:u,operacao:e.id,nota:e.nota,data:t.toISOString().split("T")[0],valorOriginal:parseFloat(e.valor),descontoJuros:e.valorDesconto,valor:e.valor-e.valorDesconto};s.push(a)}),Promise.all(s.map(e=>{o.innerHTML="Efetuando antecipa\xe7\xe3o nota fiscal "+e.nota+"…",l.innerHTML=f+"%",fetch("fetch.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.text()).then(t=>{f+=a[0],l.innerHTML=f+"%",i.setAttribute("aria-valuenow",f),i.style.width=f+"%",c.innerHTML+="✔ Opera\xe7\xe3o com nota fiscal "+e.nota+" antecipada.<br>"})})).then(()=>{setTimeout(function(){o.innerHTML="Redigindo contrato para a opera\xe7\xe3o "+u+"…",fetch("contrato.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({id:u})}).then(e=>e.text()).then(e=>{!0===(e=JSON.parse(e)).criado?(f+=a[1],l.innerHTML=f+"%",i.setAttribute("aria-valuenow",f),i.style.width=f+"%",c.innerHTML+='✔ Contrato criado: <a target="_blank" href="'+e.nome+'">'+e.nome+"</a>.<br>",o.innerHTML="Enviando contrato para assinaturas…",fetch("autentique.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({emailEmpresa:e.emailEmpresa,arquivo:e.nome,id_operacao:e.id_operacao})}).then(e=>e.text()).then(e=>{if(e=JSON.parse(e),console.log(e),Array.isArray(e)){if(4==e.length){let t=JSON.parse(e[3]);f+=a[2],o.innerHTML="",l.innerHTML=f+"%",i.setAttribute("aria-valuenow",f),i.style.width=f+"%",c.innerHTML+="✔ Contrato enviado para assinaturas. Id autentique: "+t.data.createDocument.id,p.innerHTML="Antecipa\xe7\xe3o Conclu\xedda!"}else o.innerHTML="",l.innerHTML="100%",i.setAttribute("aria-valuenow",100),i.style.width="100%",c.innerHTML+="✖ Erro ao enviar contrato para assinatura.Erro: "+e,p.innerHTML="Antecipa\xe7\xe3o Conclu\xedda!"}else o.innerHTML="",l.innerHTML="100%",i.setAttribute("aria-valuenow",100),i.style.width="100%",c.innerHTML+="✖ Erro ao enviar contrato para assinatura. Erro: "+e,p.innerHTML="Antecipa\xe7\xe3o Conclu\xedda!"})):(o.innerHTML="",l.innerHTML="100%",i.setAttribute("aria-valuenow",100),i.style.width="100%",c.innerHTML+="✖ Erro ao gerar contrato para opera\xe7\xe3o "+u+".",p.innerHTML="Antecipa\xe7\xe3o Conclu\xedda!")})},250)})})}))}Promise.all(o.map(e=>fetch(e))).then(e=>Promise.all(e.map(e=>e.json()))).then(t=>{e.fornecedor=t[0],e.fornecedor.operacoes=t[1],e.fornecedor.postergadas=[],e.fornecedor.novasOperacoes=[],e.fornecedor.baixadas=t[2],e.taxas=t[3],e.feriado=t[4]}).finally(()=>(function o(){document.querySelector("#operacao-data").innerHTML=new Date(Date.now()).toLocaleDateString("pt-BR"),document.querySelector("#fornecedor").innerHTML=e.fornecedor.razao;let n=document.querySelector("#table-operacoes");n.innerHTML="";let r=e.fornecedor.limite,s=0,d=0;e.fornecedor.operacoes.length>0?e.fornecedor.operacoes.forEach((o,r)=>{s+=parseFloat(o.valor);let d=o.nota.split("/"),l=new Date(o.vencimento),i=0===parseFloat(e.fornecedor.juros)?2.5:parseFloat(e.fornecedor.juros),c=new Date(t.getFullYear(),t.getMonth()+1,0).getDate(),p=l.getDay(),f=1;switch(p){case 0:f+=1;break;case 5:f+=3;break;case 6:f+=2}let u=Math.floor((l-t)/864e5)+f;o.dias=u,o.jurosDia=parseFloat(i/c).toFixed(2),o.valorDesconto=parseFloat(parseFloat(o.valor)*(o.jurosDia/100)*u).toFixed(2);let b=`<input data-bs-toggle="tooltip" data-bs-custom-class="tooltip-inverse" data-bs-placement="right" title="Selecionar" class="form-check-input operacoes-check" type="checkbox" data-attr="${r}" />`,m=document.createElement("tr");m.innerHTML=`
					<td>
						<div class="form-check form-check-custom form-check-solid">
							${b}
						</div>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">nota fiscal</span>
						<span class="text-dark fw-bolder d-block fs-5">${d[0]}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">parcela</span>
						<span class="text-dark fw-bolder d-block fs-5">${d[1]}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">a receber</span>
						<span class="text-dark fw-bolder d-block fs-5">${a.format(o.valor)}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">vencimento</span>
						<span class="text-dark fw-bolder d-block fs-5">${l.toLocaleDateString("pt-BR")}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">juros/m\xeas</span>
						<span class="text-dark fw-bolder d-block fs-5">${i}%</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">dias</span>
						<span class="text-dark fw-bolder d-block fs-5">${o.dias}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">descontos</span>
						<span class="text-dark fw-bolder d-block fs-5">${a.format(parseFloat(o.valorDesconto).toFixed(2))}*</span>
					</td>
					<td style="width:50px;">
						<span class="d-block fs-7">&nbsp;</span>
					</td>
				`,n.appendChild(m),execTooltips()}):(n.innerHTML="",u()),e.fornecedor.baixadas.length>0&&e.fornecedor.baixadas.forEach((e,t)=>{d+=parseFloat(e.valor)}),document.querySelector("#limiteDisponivel").innerHTML=a.format(r-d),document.querySelector("#disponivel").innerHTML=a.format(s),document.querySelector("#limiteTomado").innerHTML=a.format(d),function t(){let a=document.querySelectorAll(".operacoes-check");a.forEach(t=>{t.addEventListener("click",()=>{let a=t.getAttribute("data-attr");t.checked?e.fornecedor.postergadas.push(a):e.fornecedor.postergadas.splice(e.fornecedor.postergadas.indexOf(a),1),e.fornecedor.operacoes[a].antecipar=!!t.checked,u()})})}()})()).catch(()=>console.log("erro"))}function exibeModal(){let e=document.querySelector("#trigger-modal"),t=document.querySelectorAll(".fecha-modal");t.forEach(e=>e.addEventListener("click",()=>buscar())),e.click()}function execTooltips(){var e=function(e,t){if("1"!==e.getAttribute("data-kt-initialized")){var a={};e.hasAttribute("data-bs-delay-hide")&&(a.hide=e.getAttribute("data-bs-delay-hide")),e.hasAttribute("data-bs-delay-show")&&(a.show=e.getAttribute("data-bs-delay-show")),a&&(t.delay=a),e.hasAttribute("data-bs-dismiss")&&"click"==e.getAttribute("data-bs-dismiss")&&(t.dismiss="click");var o=new bootstrap.Tooltip(e,t);return t.dismiss&&"click"===t.dismiss&&e.addEventListener("click",function(e){o.hide()}),e.setAttribute("data-kt-initialized","1"),o}};[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(t){e(t,{})})}buscar();
