function buscar(){msg=[];let e={},t=new Date(Date.now()),a=["fetch.php?f=fornecedor","fetch.php?f=operacoes","fetch.php?f=baixadas","fetch.php?f=taxas",`fetch.php?f=feriados&data=${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`],o=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2}),s=0,n=0,r=0,d=0;function l(){s=0,n=0,r=0,d=0,txBoleto=0,txTed=0,txTac=0,e.fornecedor.operacoes.forEach(e=>{!0===e.antecipar&&(s+=parseFloat(e.valor),n+=parseFloat(e.valorDesconto),d++)}),txBoleto=0===parseFloat(e.fornecedor.boleto)?parseFloat(e.taxas.find(e=>"BOLETO"===e.titulo).valor):parseFloat(e.fornecedor.boleto),r+=txBoleto*d+(txTed=0===parseFloat(e.fornecedor.ted)?parseFloat(e.taxas.find(e=>"TED"===e.titulo).valor):parseFloat(e.fornecedor.ted))+(txTac=0===parseFloat(e.fornecedor.tac)?parseFloat(e.taxas.find(e=>"TAC"===e.titulo).valor):parseFloat(e.fornecedor.tac));let a=document.querySelector("#footer-operacoes"),l=document.createElement("tr"),c="";c=0===t.getDay()||6===t.getDay()||"false"!==e.feriado?'<span class="d-block fs-7">&nbsp;</span>':`
			<button class="btn btn-active-icon-primary btn-active-text-primary" style="margin:0; padding:0;" id="efetuar-antecipadas">
				<!--begin::Svg Icon | path: assets/media/icons/duotune/arrows/arr016.svg-->
				<span class="svg-icon svg-icon-muted svg-icon-2hx"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
				<path opacity="0.3" d="M10.3 14.3L11 13.6L7.70002 10.3C7.30002 9.9 6.7 9.9 6.3 10.3C5.9 10.7 5.9 11.3 6.3 11.7L10.3 15.7C9.9 15.3 9.9 14.7 10.3 14.3Z" fill="black"/>
				<path d="M22 12C22 17.5 17.5 22 12 22C6.5 22 2 17.5 2 12C2 6.5 6.5 2 12 2C17.5 2 22 6.5 22 12ZM11.7 15.7L17.7 9.70001C18.1 9.30001 18.1 8.69999 17.7 8.29999C17.3 7.89999 16.7 7.89999 16.3 8.29999L11 13.6L7.70001 10.3C7.30001 9.89999 6.69999 9.89999 6.29999 10.3C5.89999 10.7 5.89999 11.3 6.29999 11.7L10.3 15.7C10.5 15.9 10.8 16 11 16C11.2 16 11.5 15.9 11.7 15.7Z" fill="black"/>
				</svg></span>
				<!--end::Svg Icon-->
			</button>
			`,a.innerHTML="",d>0?l.innerHTML=`
			<td>
				<span class="text-muted fw-bold d-block"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">valor original</span>
				<span class="text-dark fw-bolder d-block fs-5">${o.format(s.toFixed(2))}</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">vencimento</span>
				<span class="text-dark fw-bolder d-block fs-5">${t.toLocaleDateString("pt-BR")}</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">desconto juros</span>
				<span class="text-dark fw-bolder d-block fs-5">${o.format(n.toFixed(2))}</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">desconto taxas</span>
				<span class="text-dark fw-bolder d-block fs-5">${o.format(r.toFixed(2))}</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">valor antecipa\xe7\xe3o</span>
				<span class="text-dark fw-bolder d-block fs-5">${o.format(parseFloat(s-(n+r)).toFixed(2))}*</span>
			</td>
			<td style="width:50px; text-align:center;">
				${c}
			</td>
		`:l.innerHTML=`
			<td>
				<span class="text-muted fw-bold d-block"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7"></span>
				<span class="text-dark fw-bolder d-block fs-5"></span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">valor original</span>
				<span class="text-dark fw-bolder d-block fs-5">R$ 0,00</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">vencimento</span>
				<span class="text-dark fw-bolder d-block fs-5">--/--/----</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">desconto juros</span>
				<span class="text-dark fw-bolder d-block fs-5">R$ 0,00</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">desconto taxas</span>
				<span class="text-dark fw-bolder d-block fs-5">R$ 0,00</span>
			</td>
			<td>
				<span class="text-muted fw-bold d-block fs-7">valor antecipa\xe7\xe3o</span>
				<span class="text-dark fw-bolder d-block fs-5">R$ 0,00*</span>
			</td>
			<td style="width:50px;">
				<span class="d-block fs-7">&nbsp;</span>
			</td>
		`,a.appendChild(l);let i=null;d>0&&document.querySelector("#efetuar-antecipadas").addEventListener("click",()=>{let a=[parseFloat((30/d).toFixed(2)),25,45],o=document.querySelector("#antecipadas-efetuando"),l=document.querySelector("#antecipadas-porcentagem"),c=document.querySelector("#antecipadas-progressbar"),p=document.querySelector("#antecipadas-modal-msg"),f=document.querySelector("#antecipadas-titulo"),b=0;exibeModal();let $={metodo:"antecipadas",fornecedor:e.fornecedor.id,data:t.toISOString().split("T")[0],valorOriginal:s,descontoJuros:n,descontoTaxas:r,valor:s-(n+r),status:0};fetch("fetch.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify($)}).then(e=>e.text()).then(s=>{i=parseInt(s,10);let n=e.fornecedor.operacoes.filter(e=>!0===e.antecipar),r=[];n.forEach(e=>{let a={metodo:"detalhes",antecipada:i,operacao:e.id,nota:e.nota,data:t.toISOString().split("T")[0],valorOriginal:parseFloat(e.valor),descontoJuros:e.valorDesconto,valor:e.valor-e.valorDesconto};r.push(a)}),Promise.all(r.map(e=>{o.innerHTML="Efetuando antecipa\xe7\xe3o nota fiscal "+e.nota+"…",l.innerHTML=b+"%",fetch("fetch.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.text()).then(t=>{b+=a[0],l.innerHTML=b+"%",c.setAttribute("aria-valuenow",b),c.style.width=b+"%",p.innerHTML+="✔ Opera\xe7\xe3o com nota fiscal "+e.nota+" antecipada.<br>"})})).then(()=>{setTimeout(function(){o.innerHTML="Redigindo contrato para a opera\xe7\xe3o "+i+"…",fetch("contrato.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({id:i})}).then(e=>e.text()).then(e=>{!0===(e=JSON.parse(e)).criado?(b+=a[1],l.innerHTML=b+"%",c.setAttribute("aria-valuenow",b),c.style.width=b+"%",p.innerHTML+='✔ Contrato criado: <a target="_blank" href="'+e.nome+'">'+e.nome+"</a>.<br>",o.innerHTML="Enviando contrato para assinaturas…",fetch("autentique.php",{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({emailEmpresa:e.emailEmpresa,arquivo:e.nome,id_operacao:e.id_operacao})}).then(e=>e.text()).then(e=>{if(e=JSON.parse(e),console.log(e),Array.isArray(e)){let t=JSON.parse(e[3]);b+=a[2],o.innerHTML="",l.innerHTML=b+"%",c.setAttribute("aria-valuenow",b),c.style.width=b+"%",p.innerHTML+="✔ Contrato enviado para assinaturas. Id autentique: "+t.data.createDocument.id,f.innerHTML="Antecipa\xe7\xe3o Conclu\xedda!"}else o.innerHTML="",l.innerHTML="100%",c.setAttribute("aria-valuenow",100),c.style.width="100%",p.innerHTML+="✖ Erro ao enviar contrato para assinatura. Erro: "+e,f.innerHTML="Antecipa\xe7\xe3o Conclu\xedda!"})):(o.innerHTML="",l.innerHTML="100%",c.setAttribute("aria-valuenow",100),c.style.width="100%",p.innerHTML+="✖ Erro ao gerar contrato para opera\xe7\xe3o "+i+".",f.innerHTML="Antecipa\xe7\xe3o Conclu\xedda!")})},250)})})})}Promise.all(a.map(e=>fetch(e))).then(e=>Promise.all(e.map(e=>e.json()))).then(t=>{e.fornecedor=t[0],e.fornecedor.operacoes=t[1],e.fornecedor.baixadas=t[2],e.taxas=t[3],e.feriado=t[4]}).finally(()=>(function a(){document.querySelector("#operacao-data").innerHTML=new Date(Date.now()).toLocaleDateString("pt-BR"),document.querySelector("#fornecedor").innerHTML=e.fornecedor.razao;let s=document.querySelector("#table-operacoes");s.innerHTML="";let n=e.fornecedor.limite,r=0,d=0;e.fornecedor.operacoes.length>0?e.fornecedor.operacoes.forEach((a,n)=>{r+=parseFloat(a.valor);let d=a.nota.split("/"),l=new Date(a.vencimento),c=0===parseFloat(e.fornecedor.juros)?2.5:parseFloat(e.fornecedor.juros),i=new Date(t.getFullYear(),t.getMonth()+1,0).getDate(),p=l.getDay(),f=1;switch(p){case 0:f+=2;break;case 5:case 6:f+=3}let b=Math.floor((l-t)/864e5)+f;a.dias=b,a.jurosDia=parseFloat(c/i).toFixed(2),a.valorDesconto=parseFloat(parseFloat(a.valor)*(a.jurosDia/100)*b).toFixed(2);let $=document.createElement("tr");$.innerHTML=`
					<td>
						<div class="form-check form-check-custom form-check-solid">
							<input class="form-check-input operacoes-check" type="checkbox" data-attr="${n}" />
						</div>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">nota fiscal</span>
						<span class="text-dark fw-bolder d-block fs-5">${d[0]}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">parcela</span>
						<span class="text-dark fw-bolder d-block fs-5">${d[1]}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">a receber</span>
						<span class="text-dark fw-bolder d-block fs-5">${o.format(a.valor)}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">vencimento</span>
						<span class="text-dark fw-bolder d-block fs-5">${l.toLocaleDateString("pt-BR")}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">juros/m\xeas</span>
						<span class="text-dark fw-bolder d-block fs-5">${c}%</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">dias</span>
						<span class="text-dark fw-bolder d-block fs-5">${a.dias}</span>
					</td>
					<td>
						<span class="text-muted fw-bold d-block fs-7">descontos</span>
						<span class="text-dark fw-bolder d-block fs-5">${o.format(parseFloat(a.valorDesconto).toFixed(2))}*</span>
					</td>
					<td style="width:50px;">
						<span class="d-block fs-7">&nbsp;</span>
					</td>
				`,s.appendChild($)}):(s.innerHTML="",l()),e.fornecedor.baixadas.length>0&&e.fornecedor.baixadas.forEach((e,t)=>{d+=parseFloat(e.valor)}),document.querySelector("#limiteDisponivel").innerHTML=o.format(n-d),document.querySelector("#disponivel").innerHTML=o.format(r),document.querySelector("#limiteTomado").innerHTML=o.format(d),function t(){let a=document.querySelectorAll(".operacoes-check");a.forEach(t=>{t.addEventListener("click",()=>{let a=t.getAttribute("data-attr");e.fornecedor.operacoes[a].antecipar=!!t.checked,l()})})}()})()).catch(()=>console.log("erro"))}function exibeModal(){let e=document.querySelector("#trigger-modal"),t=document.querySelectorAll(".fecha-modal");t.forEach(e=>e.addEventListener("click",()=>buscar())),e.click()}buscar();
